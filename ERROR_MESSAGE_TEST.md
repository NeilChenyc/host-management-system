# 错误消息测试指南

## ✅ 已完成的改进

### 后端改进
1. **GlobalExceptionHandler** - 返回友好的中文错误消息
2. **权限错误** (403) - 显示具体的权限不足原因
3. **认证错误** (401) - 显示清晰的登录提示

### 前端改进  
1. **userApi.ts** - 正确提取后端返回的错误消息
2. **所有用户API** - 现在都会显示后端的友好错误消息

---

## 🧪 测试场景

### 场景1：Operation用户尝试编辑用户角色

**步骤：**
1. 用Operation用户登录（如：user1, password123）
2. 进入用户管理页面
3. 点击"Edit"按钮
4. 修改用户角色
5. 点击"Save"

**预期结果：**
- ❌ 操作失败
- 显示错误消息：**"您没有权限管理用户，仅Admin和Manager可以执行此操作"**
- 而不是简单的"403 Forbidden"

---

### 场景2：Operation用户尝试删除用户

**步骤：**
1. 用Operation用户登录
2. 进入用户管理页面
3. 点击"Delete"按钮
4. 确认删除

**预期结果：**
- ❌ 操作失败
- 显示错误消息：**"您没有权限管理用户，仅Admin和Manager可以执行此操作"**

---

### 场景3：未登录访问用户列表

**步骤：**
1. 清除浏览器localStorage（或使用无痕模式）
2. 直接访问 `http://localhost:3000/users`

**预期结果：**
- ❌ 自动跳转到登录页
- 或显示：**"未提供登录凭证，请先登录"**

---

### 场景4：Token过期后访问

**步骤：**
1. 登录后等待Token过期（默认7天）
2. 或手动修改localStorage中的token为无效值
3. 刷新页面或访问任何API

**预期结果：**
- ❌ 自动跳转到登录页
- 显示：**"登录凭证无效，请重新登录"**

---

### 场景5：Admin用户编辑用户（成功）

**步骤：**
1. 用Admin用户登录（admin, admin123）
2. 进入用户管理页面
3. 点击"Edit"按钮
4. 修改用户角色
5. 点击"Save"

**预期结果：**
- ✅ 操作成功
- 显示：**"用户更新成功"**

---

## 📋 错误消息对照表

| 场景 | HTTP状态码 | 旧消息 | 新消息（友好） |
|------|-----------|--------|---------------|
| 无权限管理用户 | 403 | Forbidden | 您没有权限管理用户，仅Admin和Manager可以执行此操作 |
| 无权限查看用户 | 403 | Forbidden | 您没有权限查看用户列表 |
| 无权限管理项目 | 403 | Forbidden | 您没有权限管理项目，仅Admin和Manager可以执行此操作 |
| 未登录 | 401 | Unauthorized | 未提供登录凭证，请先登录 |
| Token无效 | 401 | Unauthorized | 登录凭证无效，请重新登录 |
| Token过期 | 401 | Unauthorized | 登录已过期，请重新登录 |
| Token解析失败 | 401 | Unauthorized | 登录凭证解析失败，请重新登录 |

---

## 🔍 如何查看错误消息

### 方法1：前端页面显示
错误消息会通过Ant Design的`message.error()`显示在页面右上角。

### 方法2：浏览器Console
打开开发者工具(F12) → Console标签，查看详细的错误日志。

### 方法3：Network标签
打开开发者工具(F12) → Network标签 → 找到失败的请求 → 查看Response：

```json
{
  "timestamp": "2025-10-25T21:20:00",
  "code": 40302,
  "error": "权限不足",
  "message": "您没有权限管理用户，仅Admin和Manager可以执行此操作",
  "details": null
}
```

---

## 🎯 验证清单

测试以下内容确保错误消息正确显示：

- [ ] Operation用户编辑用户 → 显示"您没有权限管理用户..."
- [ ] Operation用户删除用户 → 显示"您没有权限管理用户..."
- [ ] 未登录访问 → 显示"未提供登录凭证..."
- [ ] 无效Token → 显示"登录凭证无效..."
- [ ] Admin用户编辑用户 → 成功，显示"用户更新成功"
- [ ] Manager用户编辑用户 → 成功，显示"用户更新成功"

---

## 📝 测试报告模板

```
测试日期：____________________
测试人员：____________________

场景1 - Operation编辑用户：
- 状态码：____
- 错误消息：____________________
- 是否友好：[ ] 是 [ ] 否

场景2 - Operation删除用户：
- 状态码：____
- 错误消息：____________________
- 是否友好：[ ] 是 [ ] 否

场景3 - 未登录访问：
- 状态码：____
- 错误消息：____________________
- 是否友好：[ ] 是 [ ] 否

场景4 - Admin编辑用户：
- 结果：[ ] 成功 [ ] 失败
- 消息：____________________

总体评价：____________________
```

