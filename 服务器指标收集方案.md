# 服务器指标收集方案（仅方案说明）

## 🎯 你的需求
为健康管理平台收集其他服务器上的指标（CPU、内存、磁盘、网络等）

---

## 💡 核心问题
**如何从远程服务器获取系统指标？**

---

## 🔍 三种主流方案对比

### 方案1：Agent推送模式 ⭐⭐⭐⭐⭐ (最推荐)

**原理：**
```
远程服务器                      你的平台
    ↓                              ↓
[安装Agent]  ----HTTP推送--->  [接收API]
    ↓                              ↓
[收集指标]                    [存入数据库]
```

**优点：**
- ✅ 最简单、最常用
- ✅ 实时性好
- ✅ 数据准确
- ✅ 平台压力小（被动接收）

**缺点：**
- ❌ 需要在每台服务器安装Agent
- ❌ 需要维护Agent程序

**适用场景：**
- 生产环境
- 服务器数量多
- 需要长期监控

**工具选择：**
- **开源现成的**: Prometheus Node Exporter, Telegraf
- **自己写**: Python脚本（100行代码搞定）

---

### 方案2：SSH远程采集 ⭐⭐⭐

**原理：**
```
你的平台                        远程服务器
    ↓                              ↓
[定时任务]  ----SSH登录--->    [执行命令]
    ↓                              ↓
[获取输出]  <---返回结果---    [系统指标]
```

**优点：**
- ✅ 不需要安装Agent
- ✅ 适合少量服务器

**缺点：**
- ❌ 需要SSH权限
- ❌ 平台压力大（主动拉取）
- ❌ 并发量大时性能差
- ❌ 防火墙可能限制

**适用场景：**
- 内部环境
- 服务器数量少（<10台）
- 临时监控

---

### 方案3：SNMP协议 ⭐⭐

**原理：**
```
你的平台                        远程服务器
    ↓                              ↓
[SNMP客户端] ---SNMP查询--> [SNMP服务]
    ↓                              ↓
[解析MIB]   <---返回OID---    [系统指标]
```

**优点：**
- ✅ 标准协议
- ✅ 适合网络设备

**缺点：**
- ❌ 配置复杂
- ❌ 数据粒度粗
- ❌ 不适合现代云环境

**适用场景：**
- 网络设备监控（路由器、交换机）
- 传统IT环境

---

## 🏆 推荐方案：Agent推送模式

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    你的监控平台                          │
│                                                         │
│  ┌──────────────┐      ┌──────────────┐               │
│  │  Spring Boot │ ---> │   MySQL      │               │
│  │  后端API     │      │   数据库     │               │
│  └──────────────┘      └──────────────┘               │
│         ↑                                               │
│         │ HTTP POST /api/metrics/collect               │
│         │                                               │
└─────────┼───────────────────────────────────────────────┘
          │
          │ (每1分钟推送一次)
          │
    ┌─────┴─────┬─────────┬─────────┐
    │           │         │         │
┌───▼───┐  ┌───▼───┐ ┌───▼───┐ ┌───▼───┐
│服务器1 │  │服务器2 │ │服务器3 │ │服务器N │
│       │  │       │ │       │ │       │
│Agent  │  │Agent  │ │Agent  │ │Agent  │
│运行中 │  │运行中 │ │运行中 │ │运行中 │
└───────┘  └───────┘ └───────┘ └───────┘
```

---

## 📋 实现步骤概览

### 第1步：后端准备（在你的平台上）

**要做的事：**
1. 创建数据库表存储指标数据
2. 创建API接口接收指标数据
3. 解析JSON数据并存入数据库

**需要创建的文件：**
- `ServerMetrics.java` (实体类)
- `MetricsCollectDto.java` (接收数据的DTO)
- `MetricsCollectorController.java` (API接口)
- `MetricsService.java` (业务逻辑)

**API示例：**
```
POST /api/metrics/collect
Headers: Authorization: Bearer <token>
Body: {
  "serverId": 1,
  "timestamp": "2024-01-15T10:30:00",
  "cpu": {"usage": 45.2},
  "memory": {"percent": 68.5},
  "disk": {"percent": 72.3}
}
```

---

### 第2步：Agent准备（在被监控的服务器上）

**要做的事：**
1. 写一个小程序（Python或Java）
2. 定时收集本机指标
3. 通过HTTP发送到你的平台

**Agent核心功能：**
```
while True:
    1. 读取CPU使用率
    2. 读取内存使用率
    3. 读取磁盘使用率
    4. 读取网络流量
    5. 打包成JSON
    6. POST到平台API
    7. 等待60秒
```

---

### 第3步：部署和测试

**部署流程：**
1. 在一台测试服务器安装Agent
2. 配置Agent的平台地址和API密钥
3. 启动Agent
4. 在平台上查看数据是否正常接收

---

## 🤔 关键决策点

### Q1: Agent用什么语言写？

| 语言 | 优点 | 缺点 |
|------|------|------|
| **Python** | 简单、跨平台、库丰富(psutil) | 需要Python环境 |
| **Java** | 你已经熟悉、企业级 | 体积大、启动慢 |
| **Go** | 单文件、性能好、无依赖 | 需要学习新语言 |

**建议：Python** （100行代码搞定，依赖少）

---

### Q2: 用现成的还是自己写？

| 方案 | 优点 | 缺点 | 建议 |
|------|------|------|------|
| **现成工具** (Prometheus) | 成熟稳定、功能强大 | 学习成本、配置复杂 | 生产环境 |
| **自己写** | 灵活、简单、可控 | 功能有限 | Demo/学习 |

**建议：**
- **如果是课程项目/Demo**: 自己写（展示技术能力）
- **如果是生产环境**: 用Prometheus

---

### Q3: 数据存哪里？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **MySQL** | 你已经在用、熟悉 | 时序数据查询慢 |
| **InfluxDB** | 专为时序数据设计 | 额外学习成本 |

**建议：MySQL**（你已经有了，够用）

---

## 📊 数据库设计建议

### 表结构概念

```
server_metrics 表
├── id (主键)
├── server_id (外键 -> servers表)
├── timestamp (时间戳)
├── cpu_usage (CPU使用率 %)
├── memory_usage (内存使用率 %)
├── disk_usage (磁盘使用率 %)
├── network_in (入网流量 bytes)
├── network_out (出网流量 bytes)
└── created_at (记录创建时间)
```

**索引：**
- `(server_id, timestamp)` 组合索引（查询某服务器某时间段的数据）

**数据保留策略：**
- 原始数据保留7天
- 定时任务聚合为5分钟/1小时数据
- 聚合数据保留1年

---

## 🔐 安全考虑

### 1. API认证
- Agent需要携带API密钥或JWT token
- 每台服务器分配唯一密钥

### 2. 数据验证
- 验证serverId是否存在
- 验证数据格式是否正确
- 防止恶意数据注入

### 3. 网络安全
- 使用HTTPS传输
- 可选：IP白名单限制

---

## ⚡ 性能考虑

### 指标采集频率
- **实时监控**: 10-30秒（压力大）
- **一般监控**: 1分钟（推荐）
- **历史分析**: 5分钟（够用）

### 数据量估算
```
1台服务器：
- 每分钟采集1次
- 每次数据约1KB
- 1天 = 1440次 = 1.4MB
- 100台服务器/月 = 4.2GB

可控！
```

---

## 🎯 最简实现方案（Demo级别）

### 需要的文件（后端）
1. `MetricsCollectDto.java` - 接收数据的DTO
2. `ServerMetrics.java` - 数据库实体
3. `MetricsCollectorController.java` - API接口
4. `MetricsService.java` - 保存数据的逻辑
5. `数据库建表SQL`

### 需要的文件（Agent端）
1. `server_agent.py` - Python采集脚本（约150行）
2. `config.json` - 配置文件

### 部署流程
1. 在平台添加API接口
2. 在测试服务器部署Agent
3. 配置Agent连接到平台
4. 启动Agent
5. 在平台查看数据

---

## 📝 下一步？

**请告诉我：**

1. **这是课程项目还是生产环境？**
   - 课程项目 → 我给你写简单的自定义Agent
   - 生产环境 → 我帮你配置Prometheus

2. **被监控的服务器是什么系统？**
   - Linux → 简单
   - Windows → 需要额外处理
   - 都有 → 用跨平台方案

3. **大概有多少台服务器要监控？**
   - <10台 → 简单方案就行
   - >10台 → 需要考虑性能优化

4. **你偏好哪种方案？**
   - 方案1：Agent推送（推荐）
   - 方案2：SSH拉取
   - 方案3：用现成的Prometheus

**确认方案后，我再给你写具体代码！** 👍

